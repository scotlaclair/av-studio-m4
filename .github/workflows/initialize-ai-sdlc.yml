name: Initialize AI-First SDLC

on:
  workflow_dispatch:
    inputs:
      create_labels:
        description: 'Create all project labels'
        type: boolean
        default: true
      create_issues:
        description: 'Create all task issues'
        type: boolean
        default: true
      phase:
        description: 'Which phase to create (all, 1, 2, 3, 4, 5, 6, 7)'
        type: string
        default: 'all'

env:
  PROJECT_NUMBER: "2"
  PROJECT_OWNER: "scotlaclair"

jobs:
  setup-labels:
    if: ${{ inputs.create_labels }}
    runs-on: ubuntu-latest
    steps:
      - name: Create all labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AUTOMATION_TOKEN }}
          script: |
            const labels = [
              { name: 'P0-critical', color: 'B60205', description: 'Critical - blocks release' },
              { name: 'P1-high', color: 'D93F0B', description: 'High priority' },
              { name: 'P2-medium', color: 'FBCA04', description: 'Medium priority' },
              { name: 'P3-low', color: '0E8A16', description: 'Low priority' },
              { name: 'type:feature', color: '1D76DB', description: 'New feature' },
              { name: 'type:infra', color: '5319E7', description: 'Infrastructure' },
              { name: 'type:docs', color: '0075CA', description: 'Documentation' },
              { name: 'type:test', color: 'BFD4F2', description: 'Testing' },
              { name: 'type:security', color: 'B60205', description: 'Security' },
              { name: 'phase:1-foundation', color: 'C2E0C6', description: 'Phase 1: Foundation' },
              { name: 'phase:2-gateway', color: 'BFDADC', description: 'Phase 2: Gateway Layer' },
              { name: 'phase:3-llm', color: 'D4C5F9', description: 'Phase 3: LLM Integration' },
              { name: 'phase:4-audio', color: 'FEF2C0', description: 'Phase 4: Audio Processing' },
              { name: 'phase:5-agents', color: 'F9D0C4', description: 'Phase 5: Agent System' },
              { name: 'phase:6-api', color: 'C5DEF5', description: 'Phase 6: API Layer' },
              { name: 'phase:7-mcp', color: 'E6E6FA', description: 'Phase 7: MCP Server' },
              { name: 'agent:coder', color: 'FBEF79', description: 'Coder Agent (Copilot/Codex)' },
              { name: 'agent:reviewer', color: 'F9D0C4', description: 'Reviewer Agent' },
              { name: 'agent:security', color: 'E99695', description: 'Security Agent' },
              { name: 'agent:docs', color: 'C5DEF5', description: 'Documentation Agent' },
              { name: 'gate:blocked', color: 'B60205', description: 'Blocked at gate' },
              { name: 'gate:human-required', color: 'D93F0B', description: 'Human approval needed' },
              { name: 'gate:passed', color: '0E8A16', description: 'Gate passed' }
            ];
            
            for (const label of labels) {
              try {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ...label
                });
                console.log('Created: ' + label.name);
              } catch (e) {
                if (e.status === 422) {
                  console.log('Exists: ' + label.name);
                } else {
                  console.error('Failed: ' + label.name + ' - ' + e.message);
                }
              }
            }

  create-dev-branch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.AUTOMATION_TOKEN }}
      - name: Create dev branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b dev 2>/dev/null || git checkout dev
          git push origin dev -u || echo "Branch already exists"

  create-issues:
    if: ${{ inputs.create_issues }}
    needs: [setup-labels, create-dev-branch]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Create All Task Issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AUTOMATION_TOKEN }}
          script: |
            const phase = '${{ inputs.phase }}';
            
            const phaseNames = {
              '1': 'foundation',
              '2': 'gateway', 
              '3': 'llm',
              '4': 'audio',
              '5': 'agents',
              '6': 'api',
              '7': 'mcp'
            };
            
            const allTasks = [
              {
                id: 'INFRA-001',
                title: '[INFRA-001] Initialize repository structure',
                phase: '1',
                priority: 'P0-critical',
                type: 'type:infra',
                body: [
                  '## Task: INFRA-001 - Initialize repository structure',
                  '',
                  '**Phase:** 1 - Foundation | **Priority:** P0-critical | **Estimate:** 2 hours',
                  '**Dependencies:** None',
                  '',
                  '---',
                  '',
                  '### Description',
                  'Set up the initial repository structure per spec-kit design.',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] pyproject.toml with all dependencies',
                  '- [ ] src/av_studio/ package structure created',
                  '- [ ] .github/workflows/ directory created', 
                  '- [ ] spec-kit/ directory organized',
                  '- [ ] .env.example with all required variables',
                  '',
                  '### Files to Create',
                  '- pyproject.toml',
                  '- src/av_studio/__init__.py',
                  '- src/av_studio/py.typed',
                  '- .env.example',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'INFRA-002',
                title: '[INFRA-002] Configure CI/CD pipelines',
                phase: '1',
                priority: 'P0-critical',
                type: 'type:infra',
                body: [
                  '## Task: INFRA-002 - Configure CI/CD pipelines',
                  '',
                  '**Phase:** 1 - Foundation | **Priority:** P0-critical | **Estimate:** 4 hours',
                  '**Dependencies:** INFRA-001',
                  '',
                  '---',
                  '',
                  '### Description',
                  'Set up GitHub Actions workflows for CI/CD.',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] Lint workflow (ruff) on PR',
                  '- [ ] Test workflow (pytest) on PR',
                  '- [ ] Type check workflow (mypy) on PR',
                  '- [ ] Security scan workflow',
                  '',
                  '### Files to Create',
                  '- .github/workflows/lint.yml',
                  '- .github/workflows/test.yml',
                  '- .github/workflows/typecheck.yml',
                  '- .github/workflows/security.yml',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'INFRA-003',
                title: '[INFRA-003] Setup development environment scripts',
                phase: '1',
                priority: 'P1-high',
                type: 'type:infra',
                body: [
                  '## Task: INFRA-003 - Setup development environment scripts',
                  '',
                  '**Phase:** 1 - Foundation | **Priority:** P1-high | **Estimate:** 2 hours',
                  '**Dependencies:** INFRA-001',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] setup.sh installs all dependencies',
                  '- [ ] Creates required directories',
                  '- [ ] Downloads default MLX models',
                  '- [ ] Verifies GPU availability',
                  '',
                  '### Files to Create',
                  '- scripts/setup.sh',
                  '- scripts/verify_gpu.py',
                  '- scripts/download_models.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'CFG-001',
                title: '[CFG-001] Implement settings module with Pydantic',
                phase: '1',
                priority: 'P0-critical',
                type: 'type:feature',
                body: [
                  '## Task: CFG-001 - Implement settings module with Pydantic',
                  '',
                  '**Phase:** 1 - Foundation | **Priority:** P0-critical | **Estimate:** 3 hours',
                  '**Dependencies:** INFRA-001',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] All settings defined with types and defaults',
                  '- [ ] Environment variable loading works',
                  '- [ ] Validation for paths, URLs, limits',
                  '- [ ] Settings singleton accessible globally',
                  '',
                  '### Files to Create',
                  '- src/av_studio/config/__init__.py',
                  '- src/av_studio/config/settings.py',
                  '- tests/config/test_settings.py',
                  '',
                  '### Reference',
                  'See: av_studio_config_settings.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'CFG-002',
                title: '[CFG-002] Create model configuration registry',
                phase: '1',
                priority: 'P0-critical',
                type: 'type:feature',
                body: [
                  '## Task: CFG-002 - Create model configuration registry',
                  '',
                  '**Phase:** 1 - Foundation | **Priority:** P0-critical | **Estimate:** 2 hours',
                  '**Dependencies:** CFG-001',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] YAML-based model definitions',
                  '- [ ] Model capabilities defined',
                  '- [ ] Runtime model registry with lookup',
                  '',
                  '### Files to Create',
                  '- config/models.yaml',
                  '- src/av_studio/config/models.py',
                  '- tests/config/test_models.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'CFG-003',
                title: '[CFG-003] Implement pricing configuration',
                phase: '1',
                priority: 'P1-high',
                type: 'type:feature',
                body: [
                  '## Task: CFG-003 - Implement pricing configuration',
                  '',
                  '**Phase:** 1 - Foundation | **Priority:** P1-high | **Estimate:** 1 hour',
                  '**Dependencies:** CFG-001',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] YAML-based pricing definitions',
                  '- [ ] Per-model input/output token rates',
                  '- [ ] Easy to update when prices change',
                  '',
                  '### Files to Create',
                  '- config/pricing.yaml',
                  '- src/av_studio/config/pricing.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'GW-001',
                title: '[GW-001] Implement token analyzer',
                phase: '2',
                priority: 'P0-critical',
                type: 'type:feature',
                body: [
                  '## Task: GW-001 - Implement token analyzer',
                  '',
                  '**Phase:** 2 - Gateway | **Priority:** P0-critical | **Estimate:** 4 hours',
                  '**Dependencies:** CFG-002',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] Tiktoken integration for OpenAI models',
                  '- [ ] Llama tokenizer for local models',
                  '- [ ] Accurate count within 5% of actual',
                  '- [ ] Support for chat message format',
                  '',
                  '### Files to Create',
                  '- src/av_studio/gateway/__init__.py',
                  '- src/av_studio/gateway/token_analyzer.py',
                  '- tests/gateway/test_token_analyzer.py',
                  '',
                  '### Reference',
                  'See: av_studio_src_gateway_token_analyzer.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'GW-002',
                title: '[GW-002] Implement cost calculator',
                phase: '2',
                priority: 'P0-critical',
                type: 'type:feature',
                body: [
                  '## Task: GW-002 - Implement cost calculator',
                  '',
                  '**Phase:** 2 - Gateway | **Priority:** P0-critical | **Estimate:** 3 hours',
                  '**Dependencies:** GW-001, CFG-003',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] Accurate cost estimation before request',
                  '- [ ] Running total tracking',
                  '- [ ] Budget limit enforcement',
                  '- [ ] Cost summary reporting',
                  '',
                  '### Files to Create',
                  '- src/av_studio/gateway/cost_calculator.py',
                  '- tests/gateway/test_cost_calculator.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'GW-003',
                title: '[GW-003] Implement smart router',
                phase: '2',
                priority: 'P0-critical',
                type: 'type:feature',
                body: [
                  '## Task: GW-003 - Implement smart router',
                  '',
                  '**Phase:** 2 - Gateway | **Priority:** P0-critical | **Estimate:** 6 hours',
                  '**Dependencies:** GW-001, GW-002, CFG-002',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] Routes based on task type, cost, latency, quality',
                  '- [ ] Local-first preference honored',
                  '- [ ] Fallback chain works',
                  '- [ ] Latency tracking and adaptation',
                  '- [ ] Routing decisions logged',
                  '',
                  '### Files to Create',
                  '- src/av_studio/gateway/router.py',
                  '- tests/gateway/test_router.py',
                  '',
                  '### Reference',
                  'See: av_studio_src_gateway_router.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'GW-004',
                title: '[GW-004] Implement authentication middleware',
                phase: '2',
                priority: 'P1-high',
                type: 'type:feature',
                body: [
                  '## Task: GW-004 - Implement authentication middleware',
                  '',
                  '**Phase:** 2 - Gateway | **Priority:** P1-high | **Estimate:** 3 hours',
                  '**Dependencies:** INFRA-001',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] API key validation',
                  '- [ ] JWT token support',
                  '- [ ] Rate limiting per key',
                  '- [ ] Unauthorized rejection',
                  '',
                  '### Files to Create',
                  '- src/av_studio/gateway/auth.py',
                  '- tests/gateway/test_auth.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'GW-005',
                title: '[GW-005] Implement rate limiter',
                phase: '2',
                priority: 'P1-high',
                type: 'type:feature',
                body: [
                  '## Task: GW-005 - Implement rate limiter',
                  '',
                  '**Phase:** 2 - Gateway | **Priority:** P1-high | **Estimate:** 2 hours',
                  '**Dependencies:** GW-004',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] Configurable limits per endpoint',
                  '- [ ] Token bucket algorithm',
                  '- [ ] Returns 429 with retry-after',
                  '',
                  '### Files to Create',
                  '- src/av_studio/gateway/rate_limiter.py',
                  '- tests/gateway/test_rate_limiter.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'LLM-001',
                title: '[LLM-001] Implement MLX client',
                phase: '3',
                priority: 'P0-critical',
                type: 'type:feature',
                body: [
                  '## Task: LLM-001 - Implement MLX client',
                  '',
                  '**Phase:** 3 - LLM Integration | **Priority:** P0-critical | **Estimate:** 6 hours',
                  '**Dependencies:** CFG-001',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] Load MLX models from HuggingFace',
                  '- [ ] Generate completions with <50ms first token',
                  '- [ ] Streaming support',
                  '- [ ] Memory management',
                  '- [ ] Proper prompt formatting for chat',
                  '',
                  '### Files to Create',
                  '- src/av_studio/llm/__init__.py',
                  '- src/av_studio/llm/mlx_client.py',
                  '- tests/llm/test_mlx_client.py',
                  '',
                  '### Reference',
                  'See: av_studio_src_llm_mlx_client.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'LLM-002',
                title: '[LLM-002] Implement Ollama client',
                phase: '3',
                priority: 'P0-critical',
                type: 'type:feature',
                body: [
                  '## Task: LLM-002 - Implement Ollama client',
                  '',
                  '**Phase:** 3 - LLM Integration | **Priority:** P0-critical | **Estimate:** 3 hours',
                  '**Dependencies:** CFG-001',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] Connect to local Ollama server',
                  '- [ ] List available models',
                  '- [ ] Chat completions',
                  '- [ ] Streaming support',
                  '- [ ] Error handling for server down',
                  '',
                  '### Files to Create',
                  '- src/av_studio/llm/ollama_client.py',
                  '- tests/llm/test_ollama_client.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'LLM-003',
                title: '[LLM-003] Implement external API clients',
                phase: '3',
                priority: 'P0-critical',
                type: 'type:feature',
                body: [
                  '## Task: LLM-003 - Implement external API clients',
                  '',
                  '**Phase:** 3 - LLM Integration | **Priority:** P0-critical | **Estimate:** 4 hours',
                  '**Dependencies:** CFG-001, GW-002',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] OpenAI client with all models',
                  '- [ ] Anthropic client with all models',
                  '- [ ] Google/Gemini client',
                  '- [ ] Unified interface',
                  '- [ ] Cost tracking integration',
                  '',
                  '### Files to Create',
                  '- src/av_studio/llm/external_clients.py',
                  '- tests/llm/test_external_clients.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'LLM-004',
                title: '[LLM-004] Implement unified LLM interface',
                phase: '3',
                priority: 'P0-critical',
                type: 'type:feature',
                body: [
                  '## Task: LLM-004 - Implement unified LLM interface',
                  '',
                  '**Phase:** 3 - LLM Integration | **Priority:** P0-critical | **Estimate:** 3 hours',
                  '**Dependencies:** LLM-001, LLM-002, LLM-003, GW-003',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] Single interface for all LLM backends',
                  '- [ ] Automatic routing via smart router',
                  '- [ ] Consistent response format',
                  '- [ ] Error handling and retries',
                  '',
                  '### Files to Create',
                  '- src/av_studio/llm/unified.py',
                  '- tests/llm/test_unified.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'AUD-001',
                title: '[AUD-001] Implement Demucs stem separation',
                phase: '4',
                priority: 'P0-critical',
                type: 'type:feature',
                body: [
                  '## Task: AUD-001 - Implement Demucs stem separation',
                  '',
                  '**Phase:** 4 - Audio Processing | **Priority:** P0-critical | **Estimate:** 6 hours',
                  '**Dependencies:** INFRA-001',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] Separate into vocals, drums, bass, other',
                  '- [ ] MPS GPU acceleration working',
                  '- [ ] Support htdemucs, htdemucs_ft, mdx_extra models',
                  '- [ ] Progress callback for UI updates',
                  '- [ ] Output to configured directory',
                  '',
                  '### Files to Create',
                  '- src/av_studio/processing/__init__.py',
                  '- src/av_studio/processing/audio/__init__.py',
                  '- src/av_studio/processing/audio/demucs_processor.py',
                  '- tests/processing/audio/test_demucs.py',
                  '',
                  '### Reference',
                  'See: av_studio_src_processing_audio_pipeline.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'AUD-002',
                title: '[AUD-002] Implement Whisper transcription',
                phase: '4',
                priority: 'P0-critical',
                type: 'type:feature',
                body: [
                  '## Task: AUD-002 - Implement Whisper transcription',
                  '',
                  '**Phase:** 4 - Audio Processing | **Priority:** P0-critical | **Estimate:** 4 hours',
                  '**Dependencies:** INFRA-001',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] Transcribe audio with timestamps',
                  '- [ ] Support all Whisper model sizes',
                  '- [ ] Language detection or specification',
                  '- [ ] VAD filtering for better accuracy',
                  '',
                  '### Files to Create',
                  '- src/av_studio/processing/audio/whisper_processor.py',
                  '- tests/processing/audio/test_whisper.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'AUD-003',
                title: '[AUD-003] Implement audio effects pipeline',
                phase: '4',
                priority: 'P1-high',
                type: 'type:feature',
                body: [
                  '## Task: AUD-003 - Implement audio effects pipeline',
                  '',
                  '**Phase:** 4 - Audio Processing | **Priority:** P1-high | **Estimate:** 4 hours',
                  '**Dependencies:** INFRA-001',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] Pedalboard integration',
                  '- [ ] Reverb, compression, EQ, gain effects',
                  '- [ ] Effect chain composition',
                  '- [ ] Preset system',
                  '',
                  '### Files to Create',
                  '- src/av_studio/processing/audio/effects.py',
                  '- tests/processing/audio/test_effects.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'AUD-004',
                title: '[AUD-004] Implement loudness normalization',
                phase: '4',
                priority: 'P1-high',
                type: 'type:feature',
                body: [
                  '## Task: AUD-004 - Implement loudness normalization',
                  '',
                  '**Phase:** 4 - Audio Processing | **Priority:** P1-high | **Estimate:** 2 hours',
                  '**Dependencies:** INFRA-001',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] Measure current LUFS',
                  '- [ ] Normalize to target LUFS',
                  '- [ ] True peak limiting',
                  '- [ ] Streaming platform presets',
                  '',
                  '### Files to Create',
                  '- src/av_studio/processing/audio/normalization.py',
                  '- tests/processing/audio/test_normalization.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'AUD-005',
                title: '[AUD-005] Implement audio format conversion',
                phase: '4',
                priority: 'P2-medium',
                type: 'type:feature',
                body: [
                  '## Task: AUD-005 - Implement audio format conversion',
                  '',
                  '**Phase:** 4 - Audio Processing | **Priority:** P2-medium | **Estimate:** 2 hours',
                  '**Dependencies:** INFRA-001',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] Support WAV, MP3, FLAC, AAC, OGG',
                  '- [ ] Quality presets',
                  '- [ ] Metadata preservation',
                  '',
                  '### Files to Create',
                  '- src/av_studio/processing/audio/converter.py',
                  '- tests/processing/audio/test_converter.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'AUD-006',
                title: '[AUD-006] Implement unified audio pipeline',
                phase: '4',
                priority: 'P0-critical',
                type: 'type:feature',
                body: [
                  '## Task: AUD-006 - Implement unified audio pipeline',
                  '',
                  '**Phase:** 4 - Audio Processing | **Priority:** P0-critical | **Estimate:** 3 hours',
                  '**Dependencies:** AUD-001 through AUD-005',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] Single entry point for all audio operations',
                  '- [ ] Batch processing support',
                  '- [ ] Resource management (GPU memory)',
                  '- [ ] Progress tracking',
                  '',
                  '### Files to Create',
                  '- src/av_studio/processing/audio/pipeline.py',
                  '- tests/processing/audio/test_pipeline.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'AGT-001',
                title: '[AGT-001] Implement base agent class',
                phase: '5',
                priority: 'P0-critical',
                type: 'type:feature',
                body: [
                  '## Task: AGT-001 - Implement base agent class',
                  '',
                  '**Phase:** 5 - Agent System | **Priority:** P0-critical | **Estimate:** 4 hours',
                  '**Dependencies:** LLM-004',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] Abstract base with common functionality',
                  '- [ ] System prompt management',
                  '- [ ] Tool use capability',
                  '- [ ] Memory/context management',
                  '- [ ] Logging and observability',
                  '',
                  '### Files to Create',
                  '- src/av_studio/agents/__init__.py',
                  '- src/av_studio/agents/base_agent.py',
                  '- tests/agents/test_base_agent.py',
                  '',
                  '### Reference',
                  'See: av_studio_src_agents_orchestrator.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'AGT-002',
                title: '[AGT-002] Implement orchestrator agent',
                phase: '5',
                priority: 'P0-critical',
                type: 'type:feature',
                body: [
                  '## Task: AGT-002 - Implement orchestrator agent',
                  '',
                  '**Phase:** 5 - Agent System | **Priority:** P0-critical | **Estimate:** 8 hours',
                  '**Dependencies:** AGT-001',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] Task decomposition',
                  '- [ ] Agent routing/assignment',
                  '- [ ] State machine for task lifecycle',
                  '- [ ] Result synthesis',
                  '- [ ] Error handling and recovery',
                  '',
                  '### Files to Create',
                  '- src/av_studio/agents/orchestrator.py',
                  '- tests/agents/test_orchestrator.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'AGT-003',
                title: '[AGT-003] Implement audio agent',
                phase: '5',
                priority: 'P0-critical',
                type: 'type:feature',
                body: [
                  '## Task: AGT-003 - Implement audio agent',
                  '',
                  '**Phase:** 5 - Agent System | **Priority:** P0-critical | **Estimate:** 4 hours',
                  '**Dependencies:** AGT-001, AUD-006',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] Understands audio processing requests',
                  '- [ ] Maps requests to pipeline operations',
                  '- [ ] Handles multi-step workflows',
                  '- [ ] Reports progress',
                  '',
                  '### Files to Create',
                  '- src/av_studio/agents/audio_agent.py',
                  '- tests/agents/test_audio_agent.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'AGT-004',
                title: '[AGT-004] Implement video agent',
                phase: '5',
                priority: 'P1-high',
                type: 'type:feature',
                body: [
                  '## Task: AGT-004 - Implement video agent',
                  '',
                  '**Phase:** 5 - Agent System | **Priority:** P1-high | **Estimate:** 4 hours',
                  '**Dependencies:** AGT-001',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] Understands video processing requests',
                  '- [ ] Frame extraction, scene detection',
                  '- [ ] Audio extraction coordination',
                  '',
                  '### Files to Create',
                  '- src/av_studio/agents/video_agent.py',
                  '- tests/agents/test_video_agent.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'AGT-005',
                title: '[AGT-005] Implement agent memory system',
                phase: '5',
                priority: 'P1-high',
                type: 'type:feature',
                body: [
                  '## Task: AGT-005 - Implement agent memory system',
                  '',
                  '**Phase:** 5 - Agent System | **Priority:** P1-high | **Estimate:** 4 hours',
                  '**Dependencies:** AGT-001',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] Short-term conversation memory',
                  '- [ ] Long-term vector memory (ChromaDB)',
                  '- [ ] Memory retrieval for context',
                  '- [ ] Memory pruning/summarization',
                  '',
                  '### Files to Create',
                  '- src/av_studio/agents/memory.py',
                  '- tests/agents/test_memory.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'API-001',
                title: '[API-001] Implement FastAPI application core',
                phase: '6',
                priority: 'P0-critical',
                type: 'type:feature',
                body: [
                  '## Task: API-001 - Implement FastAPI application core',
                  '',
                  '**Phase:** 6 - API Layer | **Priority:** P0-critical | **Estimate:** 3 hours',
                  '**Dependencies:** GW-004, GW-005',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] FastAPI app with CORS, middleware',
                  '- [ ] Health check endpoint',
                  '- [ ] OpenAPI documentation',
                  '- [ ] Error handling',
                  '',
                  '### Files to Create',
                  '- src/av_studio/api/__init__.py',
                  '- src/av_studio/api/main.py',
                  '- src/av_studio/api/middleware.py',
                  '- tests/api/test_main.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'API-002',
                title: '[API-002] Implement audio API endpoints',
                phase: '6',
                priority: 'P0-critical',
                type: 'type:feature',
                body: [
                  '## Task: API-002 - Implement audio API endpoints',
                  '',
                  '**Phase:** 6 - API Layer | **Priority:** P0-critical | **Estimate:** 4 hours',
                  '**Dependencies:** API-001, AUD-006',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] POST /audio/separate',
                  '- [ ] POST /audio/transcribe',
                  '- [ ] POST /audio/effects',
                  '- [ ] POST /audio/normalize',
                  '- [ ] Async job handling',
                  '',
                  '### Files to Create',
                  '- src/av_studio/api/routes/audio.py',
                  '- tests/api/test_audio_routes.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'API-003',
                title: '[API-003] Implement LLM API endpoints',
                phase: '6',
                priority: 'P0-critical',
                type: 'type:feature',
                body: [
                  '## Task: API-003 - Implement LLM API endpoints',
                  '',
                  '**Phase:** 6 - API Layer | **Priority:** P0-critical | **Estimate:** 3 hours',
                  '**Dependencies:** API-001, LLM-004',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] POST /llm/chat',
                  '- [ ] POST /llm/stream (SSE)',
                  '- [ ] GET /llm/models',
                  '',
                  '### Files to Create',
                  '- src/av_studio/api/routes/llm.py',
                  '- tests/api/test_llm_routes.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'API-004',
                title: '[API-004] Implement agent API endpoints',
                phase: '6',
                priority: 'P0-critical',
                type: 'type:feature',
                body: [
                  '## Task: API-004 - Implement agent API endpoints',
                  '',
                  '**Phase:** 6 - API Layer | **Priority:** P0-critical | **Estimate:** 4 hours',
                  '**Dependencies:** API-001, AGT-002',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] POST /agents/task',
                  '- [ ] GET /agents/task/{id}',
                  '- [ ] WebSocket /agents/stream/{id}',
                  '',
                  '### Files to Create',
                  '- src/av_studio/api/routes/agents.py',
                  '- tests/api/test_agent_routes.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'API-005',
                title: '[API-005] Implement gateway API endpoints',
                phase: '6',
                priority: 'P1-high',
                type: 'type:feature',
                body: [
                  '## Task: API-005 - Implement gateway API endpoints',
                  '',
                  '**Phase:** 6 - API Layer | **Priority:** P1-high | **Estimate:** 2 hours',
                  '**Dependencies:** API-001, GW-002, GW-003',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] GET /gateway/cost',
                  '- [ ] POST /gateway/analyze-tokens',
                  '- [ ] POST /gateway/route',
                  '',
                  '### Files to Create',
                  '- src/av_studio/api/routes/gateway.py',
                  '- tests/api/test_gateway_routes.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'MCP-001',
                title: '[MCP-001] Implement MCP server core',
                phase: '7',
                priority: 'P1-high',
                type: 'type:feature',
                body: [
                  '## Task: MCP-001 - Implement MCP server core',
                  '',
                  '**Phase:** 7 - MCP Server | **Priority:** P1-high | **Estimate:** 4 hours',
                  '**Dependencies:** INFRA-001',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] MCP server with stdio transport',
                  '- [ ] Tool registration system',
                  '- [ ] Resource serving',
                  '',
                  '### Files to Create',
                  '- src/av_studio/mcp/__init__.py',
                  '- src/av_studio/mcp/server.py',
                  '- tests/mcp/test_server.py',
                  '',
                  '### Reference',
                  'See: av_studio_src_mcp_server.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'MCP-002',
                title: '[MCP-002] Implement audio MCP tools',
                phase: '7',
                priority: 'P1-high',
                type: 'type:feature',
                body: [
                  '## Task: MCP-002 - Implement audio MCP tools',
                  '',
                  '**Phase:** 7 - MCP Server | **Priority:** P1-high | **Estimate:** 3 hours',
                  '**Dependencies:** MCP-001, AUD-006',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] separate_stems tool',
                  '- [ ] transcribe_audio tool',
                  '- [ ] apply_effects tool',
                  '',
                  '### Files to Create',
                  '- src/av_studio/mcp/tools/audio_tools.py',
                  '- tests/mcp/test_audio_tools.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              },
              {
                id: 'MCP-003',
                title: '[MCP-003] Implement gateway MCP tools',
                phase: '7',
                priority: 'P1-high',
                type: 'type:feature',
                body: [
                  '## Task: MCP-003 - Implement gateway MCP tools',
                  '',
                  '**Phase:** 7 - MCP Server | **Priority:** P1-high | **Estimate:** 2 hours',
                  '**Dependencies:** MCP-001, GW-003',
                  '',
                  '---',
                  '',
                  '### Acceptance Criteria',
                  '- [ ] analyze_cost tool',
                  '- [ ] route_model tool',
                  '',
                  '### Files to Create',
                  '- src/av_studio/mcp/tools/gateway_tools.py',
                  '- tests/mcp/test_gateway_tools.py',
                  '',
                  '---',
                  '**Agent:** @copilot - Implement on dev branch'
                ].join('\n')
              }
            ];

            // Filter by phase
            const tasksToCreate = phase === 'all' 
              ? allTasks 
              : allTasks.filter(t => t.phase === phase);

            console.log('Creating ' + tasksToCreate.length + ' issues for phase: ' + phase);

            // Create issues
            for (const task of tasksToCreate) {
              try {
                const phaseName = phaseNames[task.phase] || 'unknown';
                const labels = [task.priority, task.type, 'phase:' + task.phase + '-' + phaseName, 'agent:coder'];
                
                const issue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: task.title,
                  body: task.body,
                  labels: labels
                });
                
                console.log('Created issue #' + issue.data.number + ': ' + task.title);
                
                // Small delay to avoid rate limiting
                await new Promise(r => setTimeout(r, 300));
                
              } catch (e) {
                console.error('Failed to create ' + task.id + ': ' + e.message);
              }
            }
            
            console.log('Done!');
            
